<html>
    <head>
        <link rel="stylesheet" href="categorical-styles.css">
        <title>Documento de python resaltado</title>
    </head>
    <body>
        <pre><span style='color:darkblue'>#!/usr/bin python3</span>
<span style='color:crimson'>""" Main entry point to the extract process of FaceSwap """</span>

<span style='color:blueviolet'>import</span> <span style='color:darkgreen'>logging</span>
<span style='color:blueviolet'>import</span> <span style='color:darkgreen'>os</span>
<span style='color:blueviolet'>import</span> <span style='color:darkgreen'>sys</span>

<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>tqdm</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>tqdm</span>

<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>lib</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>image</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>encode_image</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>generate_thumbnail</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>ImagesLoader</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>ImagesSaver</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>lib</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>multithreading</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>MultiThread</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>lib</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>utils</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>get_folder</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>plugins</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>extract</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>pipeline</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>Extractor</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>ExtractMedia</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>scripts</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>fsmedia</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>Alignments</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>PostProcess</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>finalize</span>

<span style='color:darkgreen'>tqdm</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>monitor_interval</span> <span style='color:deepskyblue'>=</span> <span style='color:turquoise'>0</span>  <span style='color:darkblue'># workaround for TqdmSynchronisationWarning</span>
<span style='color:darkgreen'>logger</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>logging</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>getLogger</span>(<span style='color:darkgreen'>__name__</span><span style='color:deepskyblue'>)</span>  <span style='color:darkblue'># pylint: disable=invalid-name</span>


<span style='color:blueviolet'>class</span> <span style='color:darkgreen'>Extract</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>  <span style='color:darkblue'># pylint:disable=too-few-public-methods</span>
    <span style='color:crimson'>""" The Faceswap Face Extraction Process.
    The extraction process is responsible for detecting faces in a series of images/video, aligning
    these faces and then generating a mask.
    It leverages a series of user selected plugins, chained together using
    :mod:`plugins.extract.pipeline`.
    The extract process is self contained and should not be referenced by any other scripts, so it
    contains no public properties.
    Parameters
    ----------
    arguments: argparse.Namespace
        The arguments to be passed to the extraction process as generated from Faceswap's command
        line arguments
    """</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>__init__</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>arguments</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>debug</span>(<span style='color:crimson'>"Initializing %s: (args: %s"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>__class__</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>__name__</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>arguments</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>arguments</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_output_dir</span> <span style='color:deepskyblue'>=</span> <span style='color:blueviolet'>None</span> <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>skip_saving_faces</span> <span style='color:blueviolet'>else</span> <span style='color:darkgreen'>str</span>(<span style='color:darkgreen'>get_folder</span>(
            <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>output_dir</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>info</span>(<span style='color:crimson'>"Output Directory: %s"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>output_dir</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_images</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>ImagesLoader</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>input_dir</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>fast_count</span><span style='color:deepskyblue'>=</span><span style='color:blueviolet'>True</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_alignments</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>Alignments</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>,</span> <span style='color:blueviolet'>True</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_images</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>is_video</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_existing_count</span> <span style='color:deepskyblue'>=</span> <span style='color:turquoise'>0</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_set_skip_list</span>(<span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_post_process</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>PostProcess</span>(<span style='color:darkgreen'>arguments</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>configfile</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>configfile</span> <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>hasattr</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>,</span> <span style='color:crimson'>"configfile"</span><span style='color:deepskyblue'>)</span> <span style='color:blueviolet'>else</span> <span style='color:blueviolet'>None</span>
        <span style='color:darkgreen'>normalization</span> <span style='color:deepskyblue'>=</span> <span style='color:blueviolet'>None</span> <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>normalization</span> <span style='color:deepskyblue'>=</span><span style='color:deepskyblue'>=</span> <span style='color:crimson'>"none"</span> <span style='color:blueviolet'>else</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>normalization</span>

        <span style='color:darkgreen'>maskers</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>[</span><span style='color:crimson'>"components"</span><span style='color:deepskyblue'>,</span> <span style='color:crimson'>"extended"</span><span style='color:deepskyblue'>]</span>
        <span style='color:darkgreen'>maskers</span> <span style='color:deepskyblue'>+=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>masker</span> <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>masker</span> <span style='color:blueviolet'>else</span> <span style='color:deepskyblue'>[</span><span style='color:deepskyblue'>]</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_extractor</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>Extractor</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>detector</span><span style='color:deepskyblue'>,</span>
                                    <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>aligner</span><span style='color:deepskyblue'>,</span>
                                    <span style='color:darkgreen'>maskers</span><span style='color:deepskyblue'>,</span>
                                    <span style='color:darkgreen'>configfile</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>configfile</span><span style='color:deepskyblue'>,</span>
                                    <span style='color:darkgreen'>multiprocess</span><span style='color:deepskyblue'>=</span><span style='color:blueviolet'>not</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>singleprocess</span><span style='color:deepskyblue'>,</span>
                                    <span style='color:darkgreen'>exclude_gpus</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>exclude_gpus</span><span style='color:deepskyblue'>,</span>
                                    <span style='color:darkgreen'>rotate_images</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>rotate_images</span><span style='color:deepskyblue'>,</span>
                                    <span style='color:darkgreen'>min_size</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>min_size</span><span style='color:deepskyblue'>,</span>
                                    <span style='color:darkgreen'>normalize_method</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>normalization</span><span style='color:deepskyblue'>,</span>
                                    <span style='color:darkgreen'>re_feed</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>re_feed</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_threads</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>list</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_verify_output</span> <span style='color:deepskyblue'>=</span> <span style='color:blueviolet'>False</span>
        <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>debug</span>(<span style='color:crimson'>"Initialized %s"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>__class__</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>__name__</span><span style='color:deepskyblue'>)</span>

    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>property</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>_save_interval</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:crimson'>""" int: The number of frames to be processed between each saving of the alignments file if
        it has been provided, otherwise ``None`` """</span>
        <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>hasattr</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>,</span> <span style='color:crimson'>"save_interval"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
            <span style='color:blueviolet'>return</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>save_interval</span>
        <span style='color:blueviolet'>return</span> <span style='color:blueviolet'>None</span>

    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>property</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>_skip_num</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:crimson'>""" int: Number of frames to skip if extract_every_n has been provided """</span>
        <span style='color:blueviolet'>return</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>extract_every_n</span> <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>hasattr</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>,</span> <span style='color:crimson'>"extract_every_n"</span><span style='color:deepskyblue'>)</span> <span style='color:blueviolet'>else</span> <span style='color:turquoise'>1</span>

    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>_set_skip_list</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:crimson'>""" Add the skip list to the image loader
        Checks against `extract_every_n` and the existence of alignments data (can exist if
        `skip_existing` or `skip_existing_faces` has been provided) and compiles a list of frame
        indices that should not be processed, providing these to :class:`lib.image.ImagesLoader`.
        """</span>
        <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_skip_num</span> <span style='color:deepskyblue'>=</span><span style='color:deepskyblue'>=</span> <span style='color:turquoise'>1</span> <span style='color:blueviolet'>and</span> <span style='color:blueviolet'>not</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_alignments</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>data</span><span style='color:deepskyblue'>:</span>
            <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>debug</span>(<span style='color:crimson'>"No frames to be skipped"</span><span style='color:deepskyblue'>)</span>
            <span style='color:blueviolet'>return</span>
        <span style='color:darkgreen'>skip_list</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>[</span><span style='color:deepskyblue'>]</span>
        <span style='color:blueviolet'>for</span> <span style='color:darkgreen'>idx</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>filename</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>enumerate</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_images</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>file_list</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
            <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>idx</span> <span style='color:fuchsia'>%</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_skip_num</span> <span style='color:fuchsia'>!=</span> <span style='color:turquoise'>0</span><span style='color:deepskyblue'>:</span>
                <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>trace</span>(<span style='color:crimson'>"Adding image '%s' to skip list due to extract_every_n = %s"</span><span style='color:deepskyblue'>,</span>
                             <span style='color:darkgreen'>filename</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_skip_num</span><span style='color:deepskyblue'>)</span>
                <span style='color:darkgreen'>skip_list</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>append</span>(<span style='color:darkgreen'>idx</span><span style='color:deepskyblue'>)</span>
            <span style='color:darkblue'># Items may be in the alignments file if skip-existing[-faces] is selected</span>
            <span style='color:blueviolet'>elif</span> <span style='color:darkgreen'>os</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>path</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>basename</span>(<span style='color:darkgreen'>filename</span><span style='color:deepskyblue'>)</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_alignments</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>data</span><span style='color:deepskyblue'>:</span>
                <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_existing_count</span> <span style='color:deepskyblue'>+=</span> <span style='color:turquoise'>1</span>
                <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>trace</span>(<span style='color:crimson'>"Removing image: '%s' due to previously existing"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>filename</span><span style='color:deepskyblue'>)</span>
                <span style='color:darkgreen'>skip_list</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>append</span>(<span style='color:darkgreen'>idx</span><span style='color:deepskyblue'>)</span>
        <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_existing_count</span> <span style='color:fuchsia'>!=</span> <span style='color:turquoise'>0</span><span style='color:deepskyblue'>:</span>
            <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>info</span>(<span style='color:crimson'>"Skipping %s frames due to skip_existing/skip_existing_faces."</span><span style='color:deepskyblue'>,</span>
                        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_existing_count</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>debug</span>(<span style='color:crimson'>"Adding skip list: %s"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>skip_list</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_images</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>add_skip_list</span>(<span style='color:darkgreen'>skip_list</span><span style='color:deepskyblue'>)</span>

    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>process</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:crimson'>""" The entry point for triggering the Extraction Process.
        Should only be called from  :class:`lib.cli.launcher.ScriptExecutor`
        """</span>
        <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>info</span>(<span style='color:crimson'>'Starting, this may take a while...'</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkblue'># from lib.queue_manager import queue_manager ; queue_manager.debug_monitor(3)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_threaded_redirector</span>(<span style='color:crimson'>"load"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_run_extraction</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:blueviolet'>for</span> <span style='color:darkgreen'>thread</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_threads</span><span style='color:deepskyblue'>:</span>
            <span style='color:darkgreen'>thread</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>join</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_alignments</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>save</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>finalize</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_images</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>process_count</span> <span style='color:fuchsia'>+</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_existing_count</span><span style='color:deepskyblue'>,</span>
                 <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_alignments</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>faces_count</span><span style='color:deepskyblue'>,</span>
                 <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_verify_output</span><span style='color:deepskyblue'>)</span>

    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>_threaded_redirector</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>task</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>io_args</span><span style='color:deepskyblue'>=</span><span style='color:blueviolet'>None</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:crimson'>""" Redirect image input/output tasks to relevant queues in background thread
        Parameters
        ----------
        task: str
            The name of the task to be put into a background thread
        io_args: tuple, optional
            Any arguments that need to be provided to the background function
        """</span>
        <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>debug</span>(<span style='color:crimson'>"Threading task: (Task: '%s')"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>task</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>io_args</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>tuple</span>(<span style='color:deepskyblue'>)</span> <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>io_args</span> <span style='color:blueviolet'>is</span> <span style='color:blueviolet'>None</span> <span style='color:blueviolet'>else</span> (<span style='color:darkgreen'>io_args</span><span style='color:deepskyblue'>,</span> <span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>func</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>getattr</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>,</span> <span style='color:crimson'>"_{}"</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>format</span>(<span style='color:darkgreen'>task</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>io_thread</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>MultiThread</span>(<span style='color:darkgreen'>func</span><span style='color:deepskyblue'>,</span> <span style='color:fuchsia'>*</span><span style='color:darkgreen'>io_args</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>thread_count</span><span style='color:deepskyblue'>=</span><span style='color:turquoise'>1</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>io_thread</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>start</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_threads</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>append</span>(<span style='color:darkgreen'>io_thread</span><span style='color:deepskyblue'>)</span>

    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>_load</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:crimson'>""" Load the images
        Loads images from :class:`lib.image.ImagesLoader`, formats them into a dict compatible
        with :class:`plugins.extract.Pipeline.Extractor` and passes them into the extraction queue.
        """</span>
        <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>debug</span>(<span style='color:crimson'>"Load Images: Start"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>load_queue</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_extractor</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>input_queue</span>
        <span style='color:blueviolet'>for</span> <span style='color:darkgreen'>filename</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>image</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_images</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>load</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
            <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>load_queue</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>shutdown</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>is_set</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
                <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>debug</span>(<span style='color:crimson'>"Load Queue: Stop signal received. Terminating"</span><span style='color:deepskyblue'>)</span>
                <span style='color:blueviolet'>break</span>
            <span style='color:darkgreen'>item</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>ExtractMedia</span>(<span style='color:darkgreen'>filename</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>image</span><span style='color:deepskyblue'>[</span><span style='color:deepskyblue'>.</span><span style='color:deepskyblue'>.</span><span style='color:deepskyblue'>.</span><span style='color:deepskyblue'>,</span> <span style='color:deepskyblue'>:</span><span style='color:turquoise'>3</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>load_queue</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>put</span>(<span style='color:darkgreen'>item</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>load_queue</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>put</span>(<span style='color:crimson'>"EOF"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>debug</span>(<span style='color:crimson'>"Load Images: Complete"</span><span style='color:deepskyblue'>)</span>

    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>_reload</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>detected_faces</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:crimson'>""" Reload the images and pair to detected face
        When the extraction pipeline is running in serial mode, images are reloaded from disk,
        paired with their extraction data and passed back into the extraction queue
        Parameters
        ----------
        detected_faces: dict
            Dictionary of :class:`plugins.extract.pipeline.ExtractMedia` with the filename as the
            key for repopulating the image attribute.
        """</span>
        <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>debug</span>(<span style='color:crimson'>"Reload Images: Start. Detected Faces Count: %s"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>len</span>(<span style='color:darkgreen'>detected_faces</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>load_queue</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_extractor</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>input_queue</span>
        <span style='color:blueviolet'>for</span> <span style='color:darkgreen'>filename</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>image</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_images</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>load</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
            <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>load_queue</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>shutdown</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>is_set</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
                <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>debug</span>(<span style='color:crimson'>"Reload Queue: Stop signal received. Terminating"</span><span style='color:deepskyblue'>)</span>
                <span style='color:blueviolet'>break</span>
            <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>trace</span>(<span style='color:crimson'>"Reloading image: '%s'"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>filename</span><span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>extract_media</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>detected_faces</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>pop</span>(<span style='color:darkgreen'>filename</span><span style='color:deepskyblue'>,</span> <span style='color:blueviolet'>None</span><span style='color:deepskyblue'>)</span>
            <span style='color:blueviolet'>if</span> <span style='color:blueviolet'>not</span> <span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>:</span>
                <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>warning</span>(<span style='color:crimson'>"Couldn't find faces for: %s"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>filename</span><span style='color:deepskyblue'>)</span>
                <span style='color:blueviolet'>continue</span>
            <span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>set_image</span>(<span style='color:darkgreen'>image</span><span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>load_queue</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>put</span>(<span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>load_queue</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>put</span>(<span style='color:crimson'>"EOF"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>debug</span>(<span style='color:crimson'>"Reload Images: Complete"</span><span style='color:deepskyblue'>)</span>

    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>_run_extraction</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:crimson'>""" The main Faceswap Extraction process
        Receives items from :class:`plugins.extract.Pipeline.Extractor` and either saves out the
        faces and data (if on the final pass) or reprocesses data through the pipeline for serial
        processing.
        """</span>
        <span style='color:darkgreen'>size</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>size</span> <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>hasattr</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>,</span> <span style='color:crimson'>"size"</span><span style='color:deepskyblue'>)</span> <span style='color:blueviolet'>else</span> <span style='color:turquoise'>256</span>
        <span style='color:darkgreen'>saver</span> <span style='color:deepskyblue'>=</span> <span style='color:blueviolet'>None</span> <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>skip_saving_faces</span> <span style='color:blueviolet'>else</span> <span style='color:darkgreen'>ImagesSaver</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_output_dir</span><span style='color:deepskyblue'>,</span>
                                                                      <span style='color:darkgreen'>as_bytes</span><span style='color:deepskyblue'>=</span><span style='color:blueviolet'>True</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>exception</span> <span style='color:deepskyblue'>=</span> <span style='color:blueviolet'>False</span>

        <span style='color:blueviolet'>for</span> <span style='color:darkgreen'>phase</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>range</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_extractor</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>passes</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
            <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>exception</span><span style='color:deepskyblue'>:</span>
                <span style='color:blueviolet'>break</span>
            <span style='color:darkgreen'>is_final</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_extractor</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>final_pass</span>
            <span style='color:darkgreen'>detected_faces</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>dict</span>(<span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_extractor</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>launch</span>(<span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_check_thread_error</span>(<span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>ph_desc</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"Extraction"</span> <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_extractor</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>passes</span> <span style='color:deepskyblue'>=</span><span style='color:deepskyblue'>=</span> <span style='color:turquoise'>1</span> <span style='color:blueviolet'>else</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_extractor</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>phase_text</span>
            <span style='color:darkgreen'>desc</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"Running pass {} of {}: {}"</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>format</span>(<span style='color:darkgreen'>phase</span> <span style='color:fuchsia'>+</span> <span style='color:turquoise'>1</span><span style='color:deepskyblue'>,</span>
                                                      <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_extractor</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>passes</span><span style='color:deepskyblue'>,</span>
                                                      <span style='color:darkgreen'>ph_desc</span><span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>status_bar</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>tqdm</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_extractor</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>detected_faces</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>,</span>
                              <span style='color:darkgreen'>total</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_images</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>process_count</span><span style='color:deepskyblue'>,</span>
                              <span style='color:darkgreen'>file</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>sys</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>stdout</span><span style='color:deepskyblue'>,</span>
                              <span style='color:darkgreen'>desc</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>desc</span><span style='color:deepskyblue'>)</span>
            <span style='color:blueviolet'>for</span> <span style='color:darkgreen'>idx</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>extract_media</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>enumerate</span>(<span style='color:darkgreen'>status_bar</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
                <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_check_thread_error</span>(<span style='color:deepskyblue'>)</span>
                <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>is_final</span><span style='color:deepskyblue'>:</span>
                    <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_output_processing</span>(<span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>size</span><span style='color:deepskyblue'>)</span>
                    <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_output_faces</span>(<span style='color:darkgreen'>saver</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>)</span>
                    <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_save_interval</span> <span style='color:blueviolet'>and</span> (<span style='color:darkgreen'>idx</span> <span style='color:fuchsia'>+</span> <span style='color:turquoise'>1</span><span style='color:deepskyblue'>)</span> <span style='color:fuchsia'>%</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_save_interval</span> <span style='color:deepskyblue'>=</span><span style='color:deepskyblue'>=</span> <span style='color:turquoise'>0</span><span style='color:deepskyblue'>:</span>
                        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_alignments</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>save</span>(<span style='color:deepskyblue'>)</span>
                <span style='color:blueviolet'>else</span><span style='color:deepskyblue'>:</span>
                    <span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>remove_image</span>(<span style='color:deepskyblue'>)</span>
                    <span style='color:darkblue'># cache extract_media for next run</span>
                    <span style='color:darkgreen'>detected_faces</span><span style='color:deepskyblue'>[</span><span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filename</span><span style='color:deepskyblue'>]</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>extract_media</span>
                <span style='color:darkgreen'>status_bar</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>update</span>(<span style='color:turquoise'>1</span><span style='color:deepskyblue'>)</span>

            <span style='color:blueviolet'>if</span> <span style='color:blueviolet'>not</span> <span style='color:darkgreen'>is_final</span><span style='color:deepskyblue'>:</span>
                <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>debug</span>(<span style='color:crimson'>"Reloading images"</span><span style='color:deepskyblue'>)</span>
                <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_threaded_redirector</span>(<span style='color:crimson'>"reload"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>detected_faces</span><span style='color:deepskyblue'>)</span>
        <span style='color:blueviolet'>if</span> <span style='color:blueviolet'>not</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>skip_saving_faces</span><span style='color:deepskyblue'>:</span>
            <span style='color:darkgreen'>saver</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>close</span>(<span style='color:deepskyblue'>)</span>

    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>_check_thread_error</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:crimson'>""" Check if any errors have occurred in the running threads and their errors """</span>
        <span style='color:blueviolet'>for</span> <span style='color:darkgreen'>thread</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_threads</span><span style='color:deepskyblue'>:</span>
            <span style='color:darkgreen'>thread</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>check_and_raise_error</span>(<span style='color:deepskyblue'>)</span>

    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>_output_processing</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>size</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:crimson'>""" Prepare faces for output
        Loads the aligned face, generate the thumbnail, perform any processing actions and verify
        the output.
        Parameters
        ----------
        extract_media: :class:`plugins.extract.pipeline.ExtractMedia`
            Output from :class:`plugins.extract.pipeline.Extractor`
        size: int
            The size that the aligned face should be created at
        """</span>
        <span style='color:blueviolet'>for</span> <span style='color:darkgreen'>face</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>detected_faces</span><span style='color:deepskyblue'>:</span>
            <span style='color:darkgreen'>face</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>load_aligned</span>(<span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>image</span><span style='color:deepskyblue'>,</span>
                              <span style='color:darkgreen'>size</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>size</span><span style='color:deepskyblue'>,</span>
                              <span style='color:darkgreen'>centering</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"head"</span><span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>face</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>thumbnail</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>generate_thumbnail</span>(<span style='color:darkgreen'>face</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>aligned</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>face</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>size</span><span style='color:deepskyblue'>=</span><span style='color:turquoise'>96</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>quality</span><span style='color:deepskyblue'>=</span><span style='color:turquoise'>60</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_post_process</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>do_actions</span>(<span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>remove_image</span>(<span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>faces_count</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>len</span>(<span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>detected_faces</span><span style='color:deepskyblue'>)</span>
        <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>faces_count</span> <span style='color:deepskyblue'>=</span><span style='color:deepskyblue'>=</span> <span style='color:turquoise'>0</span><span style='color:deepskyblue'>:</span>
            <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>verbose</span>(<span style='color:crimson'>"No faces were detected in image: %s"</span><span style='color:deepskyblue'>,</span>
                           <span style='color:darkgreen'>os</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>path</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>basename</span>(<span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filename</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>

        <span style='color:blueviolet'>if</span> <span style='color:blueviolet'>not</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_verify_output</span> <span style='color:blueviolet'>and</span> <span style='color:darkgreen'>faces_count</span> <span style='color:fuchsia'>></span> <span style='color:turquoise'>1</span><span style='color:deepskyblue'>:</span>
            <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_verify_output</span> <span style='color:deepskyblue'>=</span> <span style='color:blueviolet'>True</span>

    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>_output_faces</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>saver</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:crimson'>""" Output faces to save thread
        Set the face filename based on the frame name and put the face to the
        :class:`~lib.image.ImagesSaver` save queue and add the face information to the alignments
        data.
        Parameters
        ----------
        saver: lib.images.ImagesSaver
            The background saver for saving the image
        extract_media: :class:`~plugins.extract.pipeline.ExtractMedia`
            The output from :class:`~plugins.extract.Pipeline.Extractor`
        """</span>
        <span style='color:darkgreen'>logger</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>trace</span>(<span style='color:crimson'>"Outputting faces for %s"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filename</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>final_faces</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>list</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>filename</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>os</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>path</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>splitext</span>(<span style='color:darkgreen'>os</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>path</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>basename</span>(<span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filename</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>[</span><span style='color:turquoise'>0</span><span style='color:deepskyblue'>]</span>
        <span style='color:darkgreen'>extension</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>".png"</span>

        <span style='color:blueviolet'>for</span> <span style='color:darkgreen'>idx</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>face</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>enumerate</span>(<span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>detected_faces</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
            <span style='color:darkgreen'>output_filename</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"{}_{}{}"</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>format</span>(<span style='color:darkgreen'>filename</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>str</span>(<span style='color:darkgreen'>idx</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>extension</span><span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>meta</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>dict</span>(<span style='color:darkgreen'>alignments</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>face</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>to_png_meta</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>,</span>
                        <span style='color:darkgreen'>source</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>dict</span>(<span style='color:darkgreen'>alignments_version</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_alignments</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>version</span><span style='color:deepskyblue'>,</span>
                                    <span style='color:darkgreen'>original_filename</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>output_filename</span><span style='color:deepskyblue'>,</span>
                                    <span style='color:darkgreen'>face_index</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>idx</span><span style='color:deepskyblue'>,</span>
                                    <span style='color:darkgreen'>source_filename</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>os</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>path</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>basename</span>(<span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filename</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>,</span>
                                    <span style='color:darkgreen'>source_is_video</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_images</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>is_video</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>image</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>encode_image</span>(<span style='color:darkgreen'>face</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>aligned</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>face</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>extension</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>metadata</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>meta</span><span style='color:deepskyblue'>)</span>

            <span style='color:blueviolet'>if</span> <span style='color:blueviolet'>not</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_args</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>skip_saving_faces</span><span style='color:deepskyblue'>:</span>
                <span style='color:darkgreen'>saver</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>save</span>(<span style='color:darkgreen'>output_filename</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>image</span><span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>final_faces</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>append</span>(<span style='color:darkgreen'>face</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>to_alignment</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>_alignments</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>data</span><span style='color:deepskyblue'>[</span><span style='color:darkgreen'>os</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>path</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>basename</span>(<span style='color:darkgreen'>extract_media</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filename</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>]</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>dict</span>(<span style='color:darkgreen'>faces</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>final_faces</span><span style='color:deepskyblue'>)</span>
        <span style='color:blueviolet'>del</span> <span style='color:darkgreen'>extract_media</span>
 <span style='color:turquoise'>2021</span> <span style='color:darkgreen'>GitHub</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>Inc</span><span style='color:deepskyblue'>.</span>
        </pre>
    </body>
</html>