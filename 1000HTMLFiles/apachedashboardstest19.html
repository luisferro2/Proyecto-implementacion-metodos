<html>
    <head>
        <link rel="stylesheet" href="categorical-styles.css">
        <title>Documento de python resaltado</title>
    </head>
    <body>
        <pre><span style='color:darkblue'># Licensed to the Apache Software Foundation (ASF) under one</span>
<span style='color:darkblue'># or more contributor license agreements.  See the NOTICE file</span>
<span style='color:darkblue'># distributed with this work for additional information</span>
<span style='color:darkblue'># regarding copyright ownership.  The ASF licenses this file</span>
<span style='color:darkblue'># to you under the Apache License, Version 2.0 (the</span>
<span style='color:darkblue'># "License"); you may not use this file except in compliance</span>
<span style='color:darkblue'># with the License.  You may obtain a copy of the License at</span>
<span style='color:darkblue'>#</span>
<span style='color:darkblue'>#   http://www.apache.org/licenses/LICENSE-2.0</span>
<span style='color:darkblue'>#</span>
<span style='color:darkblue'># Unless required by applicable law or agreed to in writing,</span>
<span style='color:darkblue'># software distributed under the License is distributed on an</span>
<span style='color:darkblue'># "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span>
<span style='color:darkblue'># KIND, either express or implied.  See the License for the</span>
<span style='color:darkblue'># specific language governing permissions and limitations</span>
<span style='color:darkblue'># under the License.</span>
<span style='color:darkblue'># isort:skip_file</span>
<span style='color:crimson'>"""Unit tests for Superset"""</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>datetime</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>datetime</span>
<span style='color:blueviolet'>import</span> <span style='color:darkgreen'>json</span>
<span style='color:blueviolet'>import</span> <span style='color:darkgreen'>unittest</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>random</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>random</span>

<span style='color:blueviolet'>import</span> <span style='color:darkgreen'>pytest</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>flask</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>escape</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>url_for</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>sqlalchemy</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>func</span>

<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>tests</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>test_app</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>app</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>superset</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>security_manager</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>superset</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>connectors</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>sqla</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>models</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>SqlaTable</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>superset</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>models</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>core</span> <span style='color:blueviolet'>as</span> <span style='color:darkgreen'>models</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>superset</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>models</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>Dashboard</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>superset</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>models</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slice</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>Slice</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>tests</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>fixtures</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>birth_names_dashboard</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>load_birth_names_dashboard_with_slices</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>tests</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>fixtures</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>energy_dashboard</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>load_energy_table_with_slice</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>tests</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>fixtures</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>public_role</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>public_role_like_gamma</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>tests</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>fixtures</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>unicode_dashboard</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>load_unicode_dashboard_with_position</span>
<span style='color:blueviolet'>from</span> <span style='color:darkgreen'>tests</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>fixtures</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>world_bank_dashboard</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>load_world_bank_dashboard_with_slices</span>

<span style='color:blueviolet'>from</span> <span style='color:deepskyblue'>.</span><span style='color:darkgreen'>base_tests</span> <span style='color:blueviolet'>import</span> <span style='color:darkgreen'>SupersetTestCase</span>


<span style='color:blueviolet'>class</span> <span style='color:darkgreen'>TestDashboard</span>(<span style='color:darkgreen'>SupersetTestCase</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>fixture</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>cleanup_copied_dash</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:blueviolet'>with</span> <span style='color:darkgreen'>app</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>app_context</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
            <span style='color:darkgreen'>original_dashboard</span> <span style='color:deepskyblue'>=</span> (
                <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"births"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
            <span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>original_dashboard_id</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>original_dashboard</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>id</span>
            <span style='color:blueviolet'>yield</span>
            <span style='color:darkgreen'>copied_dashboard</span> <span style='color:deepskyblue'>=</span> (
                <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span>
                <span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter</span>(
                    <span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard_title</span> <span style='color:deepskyblue'>=</span><span style='color:deepskyblue'>=</span> <span style='color:crimson'>"Copy Of Births"</span><span style='color:deepskyblue'>,</span>
                    <span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>id</span> <span style='color:fuchsia'>!=</span> <span style='color:darkgreen'>original_dashboard_id</span><span style='color:deepskyblue'>,</span>
                <span style='color:deepskyblue'>)</span>
                <span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
            <span style='color:deepskyblue'>)</span>

            <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>merge</span>(<span style='color:darkgreen'>original_dashboard</span><span style='color:deepskyblue'>)</span>
            <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>copied_dashboard</span><span style='color:deepskyblue'>:</span>
                <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>delete</span>(<span style='color:darkgreen'>copied_dashboard</span><span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>commit</span>(<span style='color:deepskyblue'>)</span>

    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>fixture</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>load_dashboard</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:blueviolet'>with</span> <span style='color:darkgreen'>app</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>app_context</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
            <span style='color:darkgreen'>table</span> <span style='color:deepskyblue'>=</span> (
                <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>SqlaTable</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>table_name</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"energy_usage"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>one</span>(<span style='color:deepskyblue'>)</span>
            <span style='color:deepskyblue'>)</span>
            <span style='color:darkblue'># get a slice from the allowed table</span>
            <span style='color:darkgreen'>slice</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Slice</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slice_name</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"Energy Sankey"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>one</span>(<span style='color:deepskyblue'>)</span>

            <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>grant_public_access_to_table</span>(<span style='color:darkgreen'>table</span><span style='color:deepskyblue'>)</span>

            <span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>hidden_dash_slug</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>f"hidden_dash_{random()}"</span>
            <span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>published_dash_slug</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>f"published_dash_{random()}"</span>

            <span style='color:darkblue'># Create a published and hidden dashboard and add them to the database</span>
            <span style='color:darkgreen'>published_dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>Dashboard</span>(<span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>published_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard_title</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"Published Dashboard"</span>
            <span style='color:darkgreen'>published_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slug</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>published_dash_slug</span>
            <span style='color:darkgreen'>published_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slices</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>[</span><span style='color:darkgreen'>slice</span><span style='color:deepskyblue'>]</span>
            <span style='color:darkgreen'>published_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>published</span> <span style='color:deepskyblue'>=</span> <span style='color:blueviolet'>True</span>

            <span style='color:darkgreen'>hidden_dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>Dashboard</span>(<span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>hidden_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard_title</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"Hidden Dashboard"</span>
            <span style='color:darkgreen'>hidden_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slug</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>hidden_dash_slug</span>
            <span style='color:darkgreen'>hidden_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slices</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>[</span><span style='color:darkgreen'>slice</span><span style='color:deepskyblue'>]</span>
            <span style='color:darkgreen'>hidden_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>published</span> <span style='color:deepskyblue'>=</span> <span style='color:blueviolet'>False</span>

            <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>merge</span>(<span style='color:darkgreen'>published_dash</span><span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>merge</span>(<span style='color:darkgreen'>hidden_dash</span><span style='color:deepskyblue'>)</span>
            <span style='color:blueviolet'>yield</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>commit</span>(<span style='color:deepskyblue'>)</span>

            <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>revoke_public_access_to_table</span>(<span style='color:darkgreen'>table</span><span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>delete</span>(<span style='color:darkgreen'>published_dash</span><span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>delete</span>(<span style='color:darkgreen'>hidden_dash</span><span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>commit</span>(<span style='color:deepskyblue'>)</span>

    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>get_mock_positions</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>positions</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>{</span><span style='color:crimson'>"DASHBOARD_VERSION_KEY"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>"v2"</span><span style='color:deepskyblue'>}</span>
        <span style='color:blueviolet'>for</span> <span style='color:darkgreen'>i</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>slc</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>enumerate</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slices</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
            <span style='color:darkgreen'>id</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"DASHBOARD_CHART_TYPE-{}"</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>format</span>(<span style='color:darkgreen'>i</span><span style='color:deepskyblue'>)</span>
            <span style='color:darkgreen'>d</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>{</span>
                <span style='color:crimson'>"type"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>"CHART"</span><span style='color:deepskyblue'>,</span>
                <span style='color:crimson'>"id"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>id</span><span style='color:deepskyblue'>,</span>
                <span style='color:crimson'>"children"</span><span style='color:deepskyblue'>:</span> <span style='color:deepskyblue'>[</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>,</span>
                <span style='color:crimson'>"meta"</span><span style='color:deepskyblue'>:</span> <span style='color:deepskyblue'>{</span><span style='color:crimson'>"width"</span><span style='color:deepskyblue'>:</span> <span style='color:turquoise'>4</span><span style='color:deepskyblue'>,</span> <span style='color:crimson'>"height"</span><span style='color:deepskyblue'>:</span> <span style='color:turquoise'>50</span><span style='color:deepskyblue'>,</span> <span style='color:crimson'>"chartId"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>slc</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>id</span><span style='color:deepskyblue'>}</span><span style='color:deepskyblue'>,</span>
            <span style='color:deepskyblue'>}</span>
            <span style='color:darkgreen'>positions</span><span style='color:deepskyblue'>[</span><span style='color:darkgreen'>id</span><span style='color:deepskyblue'>]</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>d</span>
        <span style='color:blueviolet'>return</span> <span style='color:darkgreen'>positions</span>

    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_dashboard</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>login</span>(<span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"admin"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>urls</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>{</span><span style='color:deepskyblue'>}</span>
        <span style='color:blueviolet'>for</span> <span style='color:darkgreen'>dash</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>all</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
            <span style='color:darkgreen'>urls</span><span style='color:deepskyblue'>[</span><span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard_title</span><span style='color:deepskyblue'>]</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>url</span>
        <span style='color:blueviolet'>for</span> <span style='color:darkgreen'>title</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>url</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>urls</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>items</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
            <span style='color:blueviolet'>assert</span> <span style='color:darkgreen'>escape</span>(<span style='color:darkgreen'>title</span><span style='color:deepskyblue'>)</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>client</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get</span>(<span style='color:darkgreen'>url</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>data</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>decode</span>(<span style='color:crimson'>"utf-8"</span><span style='color:deepskyblue'>)</span>

    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_superset_dashboard_url</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>url_for</span>(<span style='color:crimson'>"Superset.dashboard"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>dashboard_id_or_slug</span><span style='color:deepskyblue'>=</span><span style='color:turquoise'>1</span><span style='color:deepskyblue'>)</span>

    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_new_dashboard</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>login</span>(<span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"admin"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash_count_before</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>func</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>count</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>id</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>[</span><span style='color:turquoise'>0</span><span style='color:deepskyblue'>]</span>
        <span style='color:darkgreen'>url</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"/dashboard/new/"</span>
        <span style='color:darkgreen'>resp</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:darkgreen'>url</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash_count_after</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>func</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>count</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>id</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>[</span><span style='color:turquoise'>0</span><span style='color:deepskyblue'>]</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertEqual</span>(<span style='color:darkgreen'>dash_count_before</span> <span style='color:fuchsia'>+</span> <span style='color:turquoise'>1</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>dash_count_after</span><span style='color:deepskyblue'>)</span>

    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>mark</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>usefixtures</span>(<span style='color:crimson'>"load_birth_names_dashboard_with_slices"</span><span style='color:deepskyblue'>)</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_save_dash</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"admin"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>login</span>(<span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>username</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"births"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>positions</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_mock_positions</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>data</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>{</span>
            <span style='color:crimson'>"css"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>""</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"expanded_slices"</span><span style='color:deepskyblue'>:</span> <span style='color:deepskyblue'>{</span><span style='color:deepskyblue'>}</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"positions"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>positions</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"dashboard_title"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard_title</span><span style='color:deepskyblue'>,</span>
            <span style='color:darkblue'># set a further modified_time for unit test</span>
            <span style='color:crimson'>"last_modified_time"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>datetime</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>now</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>timestamp</span>(<span style='color:deepskyblue'>)</span> <span style='color:fuchsia'>+</span> <span style='color:turquoise'>1000</span><span style='color:deepskyblue'>,</span>
        <span style='color:deepskyblue'>}</span>
        <span style='color:darkgreen'>url</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"/superset/save_dash/{}/"</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>format</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>id</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>resp</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:darkgreen'>url</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>dict</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>json</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dumps</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertIn</span>(<span style='color:crimson'>"SUCCESS"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>)</span>

    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>mark</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>usefixtures</span>(<span style='color:crimson'>"load_world_bank_dashboard_with_slices"</span><span style='color:deepskyblue'>)</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_save_dash_with_filter</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"admin"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>login</span>(<span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>username</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"world_health"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>positions</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_mock_positions</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>filters</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>{</span><span style='color:darkgreen'>str</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slices</span><span style='color:deepskyblue'>[</span><span style='color:turquoise'>0</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>id</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span> <span style='color:deepskyblue'>{</span><span style='color:crimson'>"region"</span><span style='color:deepskyblue'>:</span> <span style='color:deepskyblue'>[</span><span style='color:crimson'>"North America"</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>}</span><span style='color:deepskyblue'>}</span>
        <span style='color:darkgreen'>default_filters</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>json</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dumps</span>(<span style='color:darkgreen'>filters</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>data</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>{</span>
            <span style='color:crimson'>"css"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>""</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"expanded_slices"</span><span style='color:deepskyblue'>:</span> <span style='color:deepskyblue'>{</span><span style='color:deepskyblue'>}</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"positions"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>positions</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"dashboard_title"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard_title</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"default_filters"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>default_filters</span><span style='color:deepskyblue'>,</span>
            <span style='color:darkblue'># set a further modified_time for unit test</span>
            <span style='color:crimson'>"last_modified_time"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>datetime</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>now</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>timestamp</span>(<span style='color:deepskyblue'>)</span> <span style='color:fuchsia'>+</span> <span style='color:turquoise'>1000</span><span style='color:deepskyblue'>,</span>
        <span style='color:deepskyblue'>}</span>

        <span style='color:darkgreen'>url</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"/superset/save_dash/{}/"</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>format</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>id</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>resp</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:darkgreen'>url</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>dict</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>json</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dumps</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertIn</span>(<span style='color:crimson'>"SUCCESS"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>updatedDash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"world_health"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>new_url</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>updatedDash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>url</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertIn</span>(<span style='color:crimson'>"world_health"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>new_url</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertNotIn</span>(<span style='color:crimson'>"preselect_filters"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>new_url</span><span style='color:deepskyblue'>)</span>

    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>mark</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>usefixtures</span>(<span style='color:crimson'>"load_world_bank_dashboard_with_slices"</span><span style='color:deepskyblue'>)</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_save_dash_with_invalid_filters</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"admin"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>login</span>(<span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>username</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"world_health"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>

        <span style='color:darkblue'># add an invalid filter slice</span>
        <span style='color:darkgreen'>positions</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_mock_positions</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>filters</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>{</span><span style='color:darkgreen'>str</span>(<span style='color:turquoise'>99999</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span> <span style='color:deepskyblue'>{</span><span style='color:crimson'>"region"</span><span style='color:deepskyblue'>:</span> <span style='color:deepskyblue'>[</span><span style='color:crimson'>"North America"</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>}</span><span style='color:deepskyblue'>}</span>
        <span style='color:darkgreen'>default_filters</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>json</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dumps</span>(<span style='color:darkgreen'>filters</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>data</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>{</span>
            <span style='color:crimson'>"css"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>""</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"expanded_slices"</span><span style='color:deepskyblue'>:</span> <span style='color:deepskyblue'>{</span><span style='color:deepskyblue'>}</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"positions"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>positions</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"dashboard_title"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard_title</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"default_filters"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>default_filters</span><span style='color:deepskyblue'>,</span>
            <span style='color:darkblue'># set a further modified_time for unit test</span>
            <span style='color:crimson'>"last_modified_time"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>datetime</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>now</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>timestamp</span>(<span style='color:deepskyblue'>)</span> <span style='color:fuchsia'>+</span> <span style='color:turquoise'>1000</span><span style='color:deepskyblue'>,</span>
        <span style='color:deepskyblue'>}</span>

        <span style='color:darkgreen'>url</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"/superset/save_dash/{}/"</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>format</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>id</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>resp</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:darkgreen'>url</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>dict</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>json</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dumps</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertIn</span>(<span style='color:crimson'>"SUCCESS"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>updatedDash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"world_health"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>new_url</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>updatedDash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>url</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertNotIn</span>(<span style='color:crimson'>"region"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>new_url</span><span style='color:deepskyblue'>)</span>

    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>mark</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>usefixtures</span>(<span style='color:crimson'>"load_birth_names_dashboard_with_slices"</span><span style='color:deepskyblue'>)</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_save_dash_with_dashboard_title</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"admin"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>login</span>(<span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>username</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"births"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>origin_title</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard_title</span>
        <span style='color:darkgreen'>positions</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_mock_positions</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>data</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>{</span>
            <span style='color:crimson'>"css"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>""</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"expanded_slices"</span><span style='color:deepskyblue'>:</span> <span style='color:deepskyblue'>{</span><span style='color:deepskyblue'>}</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"positions"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>positions</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"dashboard_title"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>"new title"</span><span style='color:deepskyblue'>,</span>
            <span style='color:darkblue'># set a further modified_time for unit test</span>
            <span style='color:crimson'>"last_modified_time"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>datetime</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>now</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>timestamp</span>(<span style='color:deepskyblue'>)</span> <span style='color:fuchsia'>+</span> <span style='color:turquoise'>1000</span><span style='color:deepskyblue'>,</span>
        <span style='color:deepskyblue'>}</span>
        <span style='color:darkgreen'>url</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"/superset/save_dash/{}/"</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>format</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>id</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:darkgreen'>url</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>dict</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>json</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dumps</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>updatedDash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"births"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertEqual</span>(<span style='color:darkgreen'>updatedDash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard_title</span><span style='color:deepskyblue'>,</span> <span style='color:crimson'>"new title"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkblue'># bring back dashboard original title</span>
        <span style='color:darkgreen'>data</span><span style='color:deepskyblue'>[</span><span style='color:crimson'>"dashboard_title"</span><span style='color:deepskyblue'>]</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>origin_title</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:darkgreen'>url</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>dict</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>json</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dumps</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>

    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>mark</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>usefixtures</span>(<span style='color:crimson'>"load_birth_names_dashboard_with_slices"</span><span style='color:deepskyblue'>)</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_save_dash_with_colors</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"admin"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>login</span>(<span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>username</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"births"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>positions</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_mock_positions</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>new_label_colors</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>{</span><span style='color:crimson'>"data value"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>"random color"</span><span style='color:deepskyblue'>}</span>
        <span style='color:darkgreen'>data</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>{</span>
            <span style='color:crimson'>"css"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>""</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"expanded_slices"</span><span style='color:deepskyblue'>:</span> <span style='color:deepskyblue'>{</span><span style='color:deepskyblue'>}</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"positions"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>positions</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"dashboard_title"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard_title</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"color_namespace"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>"Color Namespace Test"</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"color_scheme"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>"Color Scheme Test"</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"label_colors"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>new_label_colors</span><span style='color:deepskyblue'>,</span>
            <span style='color:darkblue'># set a further modified_time for unit test</span>
            <span style='color:crimson'>"last_modified_time"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>datetime</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>now</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>timestamp</span>(<span style='color:deepskyblue'>)</span> <span style='color:fuchsia'>+</span> <span style='color:turquoise'>1000</span><span style='color:deepskyblue'>,</span>
        <span style='color:deepskyblue'>}</span>
        <span style='color:darkgreen'>url</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"/superset/save_dash/{}/"</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>format</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>id</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:darkgreen'>url</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>dict</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>json</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dumps</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>updatedDash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"births"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertIn</span>(<span style='color:crimson'>"color_namespace"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>updatedDash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>json_metadata</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertIn</span>(<span style='color:crimson'>"color_scheme"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>updatedDash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>json_metadata</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertIn</span>(<span style='color:crimson'>"label_colors"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>updatedDash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>json_metadata</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkblue'># bring back original dashboard</span>
        <span style='color:blueviolet'>del</span> <span style='color:darkgreen'>data</span><span style='color:deepskyblue'>[</span><span style='color:crimson'>"color_namespace"</span><span style='color:deepskyblue'>]</span>
        <span style='color:blueviolet'>del</span> <span style='color:darkgreen'>data</span><span style='color:deepskyblue'>[</span><span style='color:crimson'>"color_scheme"</span><span style='color:deepskyblue'>]</span>
        <span style='color:blueviolet'>del</span> <span style='color:darkgreen'>data</span><span style='color:deepskyblue'>[</span><span style='color:crimson'>"label_colors"</span><span style='color:deepskyblue'>]</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:darkgreen'>url</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>dict</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>json</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dumps</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>

    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>mark</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>usefixtures</span>(
        <span style='color:crimson'>"load_birth_names_dashboard_with_slices"</span><span style='color:deepskyblue'>,</span>
        <span style='color:crimson'>"cleanup_copied_dash"</span><span style='color:deepskyblue'>,</span>
        <span style='color:crimson'>"load_unicode_dashboard_with_position"</span><span style='color:deepskyblue'>,</span>
    <span style='color:deepskyblue'>)</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_copy_dash</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"admin"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>login</span>(<span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>username</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"births"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>positions</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_mock_positions</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>new_label_colors</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>{</span><span style='color:crimson'>"data value"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>"random color"</span><span style='color:deepskyblue'>}</span>
        <span style='color:darkgreen'>data</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>{</span>
            <span style='color:crimson'>"css"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>""</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"duplicate_slices"</span><span style='color:deepskyblue'>:</span> <span style='color:blueviolet'>False</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"expanded_slices"</span><span style='color:deepskyblue'>:</span> <span style='color:deepskyblue'>{</span><span style='color:deepskyblue'>}</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"positions"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>positions</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"dashboard_title"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>"Copy Of Births"</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"color_namespace"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>"Color Namespace Test"</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"color_scheme"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>"Color Scheme Test"</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"label_colors"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>new_label_colors</span><span style='color:deepskyblue'>,</span>
            <span style='color:darkblue'># set a further modified_time for unit test</span>
            <span style='color:crimson'>"last_modified_time"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>datetime</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>now</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>timestamp</span>(<span style='color:deepskyblue'>)</span> <span style='color:fuchsia'>+</span> <span style='color:turquoise'>1000</span><span style='color:deepskyblue'>,</span>
        <span style='color:deepskyblue'>}</span>

        <span style='color:darkblue'># Save changes to Births dashboard and retrieve updated dash</span>
        <span style='color:darkgreen'>dash_id</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>id</span>
        <span style='color:darkgreen'>url</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"/superset/save_dash/{}/"</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>format</span>(<span style='color:darkgreen'>dash_id</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>client</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>post</span>(<span style='color:darkgreen'>url</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>dict</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>json</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dumps</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>id</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>dash_id</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>orig_json_data</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>data</span>

        <span style='color:darkblue'># Verify that copy matches original</span>
        <span style='color:darkgreen'>url</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"/superset/copy_dash/{}/"</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>format</span>(<span style='color:darkgreen'>dash_id</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>resp</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_json_resp</span>(<span style='color:darkgreen'>url</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>dict</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>json</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dumps</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertEqual</span>(<span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>[</span><span style='color:crimson'>"dashboard_title"</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>,</span> <span style='color:crimson'>"Copy Of Births"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertEqual</span>(<span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>[</span><span style='color:crimson'>"position_json"</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>orig_json_data</span><span style='color:deepskyblue'>[</span><span style='color:crimson'>"position_json"</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertEqual</span>(<span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>[</span><span style='color:crimson'>"metadata"</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>orig_json_data</span><span style='color:deepskyblue'>[</span><span style='color:crimson'>"metadata"</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkblue'># check every attribute in each dashboard's slices list,</span>
        <span style='color:darkblue'># exclude modified and changed_on attribute</span>
        <span style='color:blueviolet'>for</span> <span style='color:darkgreen'>index</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>slc</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>enumerate</span>(<span style='color:darkgreen'>orig_json_data</span><span style='color:deepskyblue'>[</span><span style='color:crimson'>"slices"</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
            <span style='color:blueviolet'>for</span> <span style='color:darkgreen'>key</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>slc</span><span style='color:deepskyblue'>:</span>
                <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>key</span> <span style='color:blueviolet'>not</span> <span style='color:blueviolet'>in</span> <span style='color:deepskyblue'>[</span><span style='color:crimson'>"modified"</span><span style='color:deepskyblue'>,</span> <span style='color:crimson'>"changed_on"</span><span style='color:deepskyblue'>,</span> <span style='color:crimson'>"changed_on_humanized"</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>:</span>
                    <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertEqual</span>(<span style='color:darkgreen'>slc</span><span style='color:deepskyblue'>[</span><span style='color:darkgreen'>key</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>[</span><span style='color:crimson'>"slices"</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>[</span><span style='color:darkgreen'>index</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>[</span><span style='color:darkgreen'>key</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>)</span>

    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>mark</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>usefixtures</span>(
        <span style='color:crimson'>"load_energy_table_with_slice"</span><span style='color:deepskyblue'>,</span> <span style='color:crimson'>"load_birth_names_dashboard_with_slices"</span>
    <span style='color:deepskyblue'>)</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_add_slices</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"admin"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>login</span>(<span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>username</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"births"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>new_slice</span> <span style='color:deepskyblue'>=</span> (
            <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Slice</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slice_name</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"Energy Force Layout"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>existing_slice</span> <span style='color:deepskyblue'>=</span> (
            <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Slice</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slice_name</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"Girl Name Cloud"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>data</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>{</span>
            <span style='color:crimson'>"slice_ids"</span><span style='color:deepskyblue'>:</span> <span style='color:deepskyblue'>[</span><span style='color:darkgreen'>new_slice</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>data</span><span style='color:deepskyblue'>[</span><span style='color:crimson'>"slice_id"</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>existing_slice</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>data</span><span style='color:deepskyblue'>[</span><span style='color:crimson'>"slice_id"</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>]</span>
        <span style='color:deepskyblue'>}</span>
        <span style='color:darkgreen'>url</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"/superset/add_slices/{}/"</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>format</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>id</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>resp</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>client</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>post</span>(<span style='color:darkgreen'>url</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>dict</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>json</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dumps</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>
        <span style='color:blueviolet'>assert</span> <span style='color:crimson'>"SLICES ADDED"</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>data</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>decode</span>(<span style='color:crimson'>"utf-8"</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"births"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>new_slice</span> <span style='color:deepskyblue'>=</span> (
            <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Slice</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slice_name</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"Energy Force Layout"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:deepskyblue'>)</span>
        <span style='color:blueviolet'>assert</span> <span style='color:darkgreen'>new_slice</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slices</span>
        <span style='color:blueviolet'>assert</span> <span style='color:darkgreen'>len</span>(<span style='color:darkgreen'>set</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slices</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span> <span style='color:deepskyblue'>=</span><span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>len</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slices</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkblue'># cleaning up</span>
        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"births"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slices</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>[</span><span style='color:darkgreen'>o</span> <span style='color:blueviolet'>for</span> <span style='color:darkgreen'>o</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slices</span> <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>o</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slice_name</span> <span style='color:fuchsia'>!=</span> <span style='color:crimson'>"Energy Force Layout"</span><span style='color:deepskyblue'>]</span>
        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>commit</span>(<span style='color:deepskyblue'>)</span>

    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>mark</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>usefixtures</span>(<span style='color:crimson'>"load_birth_names_dashboard_with_slices"</span><span style='color:deepskyblue'>)</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_remove_slices</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"admin"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>login</span>(<span style='color:darkgreen'>username</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>username</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"births"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>origin_slices_length</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>len</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slices</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>positions</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_mock_positions</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkblue'># remove one chart</span>
        <span style='color:darkgreen'>chart_keys</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>[</span><span style='color:deepskyblue'>]</span>
        <span style='color:blueviolet'>for</span> <span style='color:darkgreen'>key</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>positions</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>keys</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
            <span style='color:blueviolet'>if</span> <span style='color:darkgreen'>key</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>startswith</span>(<span style='color:crimson'>"DASHBOARD_CHART_TYPE"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
                <span style='color:darkgreen'>chart_keys</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>append</span>(<span style='color:darkgreen'>key</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>positions</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>pop</span>(<span style='color:darkgreen'>chart_keys</span><span style='color:deepskyblue'>[</span><span style='color:turquoise'>0</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>data</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>{</span>
            <span style='color:crimson'>"css"</span><span style='color:deepskyblue'>:</span> <span style='color:crimson'>""</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"expanded_slices"</span><span style='color:deepskyblue'>:</span> <span style='color:deepskyblue'>{</span><span style='color:deepskyblue'>}</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"positions"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>positions</span><span style='color:deepskyblue'>,</span>
            <span style='color:crimson'>"dashboard_title"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard_title</span><span style='color:deepskyblue'>,</span>
            <span style='color:darkblue'># set a further modified_time for unit test</span>
            <span style='color:crimson'>"last_modified_time"</span><span style='color:deepskyblue'>:</span> <span style='color:darkgreen'>datetime</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>now</span>(<span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>timestamp</span>(<span style='color:deepskyblue'>)</span> <span style='color:fuchsia'>+</span> <span style='color:turquoise'>1000</span><span style='color:deepskyblue'>,</span>
        <span style='color:deepskyblue'>}</span>

        <span style='color:darkblue'># save dash</span>
        <span style='color:darkgreen'>dash_id</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>id</span>
        <span style='color:darkgreen'>url</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"/superset/save_dash/{}/"</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>format</span>(<span style='color:darkgreen'>dash_id</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>client</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>post</span>(<span style='color:darkgreen'>url</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>dict</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>json</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dumps</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>id</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>dash_id</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>

        <span style='color:darkblue'># verify slices data</span>
        <span style='color:darkgreen'>data</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>data</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertEqual</span>(<span style='color:darkgreen'>len</span>(<span style='color:darkgreen'>data</span><span style='color:deepskyblue'>[</span><span style='color:crimson'>"slices"</span><span style='color:deepskyblue'>]</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>origin_slices_length</span> <span style='color:fuchsia'>-</span> <span style='color:turquoise'>1</span><span style='color:deepskyblue'>)</span>

    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>mark</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>usefixtures</span>(<span style='color:crimson'>"load_birth_names_dashboard_with_slices"</span><span style='color:deepskyblue'>)</span>
    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>mark</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>usefixtures</span>(<span style='color:crimson'>"public_role_like_gamma"</span><span style='color:deepskyblue'>)</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_public_user_dashboard_access</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>table</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>SqlaTable</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>table_name</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"birth_names"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>one</span>(<span style='color:deepskyblue'>)</span>

        <span style='color:darkblue'># Make the births dash published so it can be seen</span>
        <span style='color:darkgreen'>births_dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"births"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>one</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>births_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>published</span> <span style='color:deepskyblue'>=</span> <span style='color:blueviolet'>True</span>

        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>merge</span>(<span style='color:darkgreen'>births_dash</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>commit</span>(<span style='color:deepskyblue'>)</span>

        <span style='color:darkblue'># Try access before adding appropriate permissions.</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>revoke_public_access_to_table</span>(<span style='color:darkgreen'>table</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>logout</span>(<span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>resp</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:crimson'>"/api/v1/chart/"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertNotIn</span>(<span style='color:crimson'>"birth_names"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>resp</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:crimson'>"/api/v1/dashboard/"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertNotIn</span>(<span style='color:crimson'>"/superset/dashboard/births/"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>grant_public_access_to_table</span>(<span style='color:darkgreen'>table</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkblue'># Try access after adding appropriate permissions.</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertIn</span>(<span style='color:crimson'>"birth_names"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:crimson'>"/api/v1/chart/"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>resp</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:crimson'>"/api/v1/dashboard/"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertIn</span>(<span style='color:crimson'>"/superset/dashboard/births/"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkblue'># Confirm that public doesn't have access to other datasets.</span>
        <span style='color:darkgreen'>resp</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:crimson'>"/api/v1/chart/"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertNotIn</span>(<span style='color:crimson'>"wb_health_population"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>resp</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:crimson'>"/api/v1/dashboard/"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertNotIn</span>(<span style='color:crimson'>"/superset/dashboard/world_health/"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkblue'># Cleanup</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>revoke_public_access_to_table</span>(<span style='color:darkgreen'>table</span><span style='color:deepskyblue'>)</span>

    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>mark</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>usefixtures</span>(<span style='color:crimson'>"load_birth_names_dashboard_with_slices"</span><span style='color:deepskyblue'>)</span>
    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>mark</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>usefixtures</span>(<span style='color:crimson'>"public_role_like_gamma"</span><span style='color:deepskyblue'>)</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_dashboard_with_created_by_can_be_accessed_by_public_users</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>logout</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>table</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>SqlaTable</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>table_name</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"birth_names"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>one</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>grant_public_access_to_table</span>(<span style='color:darkgreen'>table</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"births"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>owners</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>[</span><span style='color:darkgreen'>security_manager</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>find_user</span>(<span style='color:crimson'>"admin"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>]</span>
        <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>created_by</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>security_manager</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>find_user</span>(<span style='color:crimson'>"admin"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>merge</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>commit</span>(<span style='color:deepskyblue'>)</span>

        <span style='color:darkblue'># this asserts a non-4xx response</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:crimson'>"/superset/dashboard/births/"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkblue'># Cleanup</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>revoke_public_access_to_table</span>(<span style='color:darkgreen'>table</span><span style='color:deepskyblue'>)</span>

    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>mark</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>usefixtures</span>(<span style='color:crimson'>"load_birth_names_dashboard_with_slices"</span><span style='color:deepskyblue'>)</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_only_owners_can_save</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"births"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>owners</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>[</span><span style='color:deepskyblue'>]</span>
        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>merge</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>commit</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>test_save_dash</span>(<span style='color:crimson'>"admin"</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>logout</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertRaises</span>(<span style='color:darkgreen'>Exception</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>test_save_dash</span><span style='color:deepskyblue'>,</span> <span style='color:crimson'>"alpha"</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>alpha</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>security_manager</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>find_user</span>(<span style='color:crimson'>"alpha"</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:crimson'>"births"</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>owners</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>[</span><span style='color:darkgreen'>alpha</span><span style='color:deepskyblue'>]</span>
        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>merge</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>commit</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>test_save_dash</span>(<span style='color:crimson'>"alpha"</span><span style='color:deepskyblue'>)</span>

    <span style='color:deepskyblue'>@</span><span style='color:darkgreen'>pytest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>mark</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>usefixtures</span>(<span style='color:crimson'>"load_energy_table_with_slice"</span><span style='color:deepskyblue'>,</span> <span style='color:crimson'>"load_dashboard"</span><span style='color:deepskyblue'>)</span>
    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_users_can_list_published_dashboard</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>login</span>(<span style='color:crimson'>"alpha"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>resp</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:crimson'>"/api/v1/dashboard/"</span><span style='color:deepskyblue'>)</span>
        <span style='color:blueviolet'>assert</span> <span style='color:crimson'>f"/superset/dashboard/{pytest.hidden_dash_slug}/"</span> <span style='color:blueviolet'>not</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>resp</span>
        <span style='color:blueviolet'>assert</span> <span style='color:crimson'>f"/superset/dashboard/{pytest.published_dash_slug}/"</span> <span style='color:blueviolet'>in</span> <span style='color:darkgreen'>resp</span>

    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_users_can_view_own_dashboard</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>user</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>security_manager</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>find_user</span>(<span style='color:crimson'>"gamma"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>my_dash_slug</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>f"my_dash_{random()}"</span>
        <span style='color:blueviolet'>not</span>_my_dash_slug <span style='color:deepskyblue'>=</span> <span style='color:crimson'>f"not_my_dash_{random()}"</span>

        <span style='color:darkblue'># Create one dashboard I own and another that I don't</span>
        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>Dashboard</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard_title</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"My Dashboard"</span>
        <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slug</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>my_dash_slug</span>
        <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>owners</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>[</span><span style='color:darkgreen'>user</span><span style='color:deepskyblue'>]</span>
        <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slices</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>[</span><span style='color:deepskyblue'>]</span>

        <span style='color:darkgreen'>hidden_dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>Dashboard</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>hidden_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard_title</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"Not My Dashboard"</span>
        <span style='color:darkgreen'>hidden_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slug</span> <span style='color:deepskyblue'>=</span> <span style='color:blueviolet'>not</span>_my_dash_slug
        <span style='color:darkgreen'>hidden_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slices</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>[</span><span style='color:deepskyblue'>]</span>
        <span style='color:darkgreen'>hidden_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>owners</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>[</span><span style='color:deepskyblue'>]</span>

        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>merge</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>merge</span>(<span style='color:darkgreen'>hidden_dash</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>commit</span>(<span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>login</span>(<span style='color:darkgreen'>user</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>username</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>resp</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:crimson'>"/api/v1/dashboard/"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertIn</span>(<span style='color:crimson'>f"/superset/dashboard/{my_dash_slug}/"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertNotIn</span>(<span style='color:crimson'>f"/superset/dashboard/{not_my_dash_slug}/"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>)</span>

    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_users_can_view_favorited_dashboards</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>user</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>security_manager</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>find_user</span>(<span style='color:crimson'>"gamma"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>fav_dash_slug</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>f"my_favorite_dash_{random()}"</span>
        <span style='color:darkgreen'>regular_dash_slug</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>f"regular_dash_{random()}"</span>

        <span style='color:darkgreen'>favorite_dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>Dashboard</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>favorite_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard_title</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"My Favorite Dashboard"</span>
        <span style='color:darkgreen'>favorite_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slug</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>fav_dash_slug</span>

        <span style='color:darkgreen'>regular_dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>Dashboard</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>regular_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard_title</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"A Plain Ol Dashboard"</span>
        <span style='color:darkgreen'>regular_dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slug</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>regular_dash_slug</span>

        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>merge</span>(<span style='color:darkgreen'>favorite_dash</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>merge</span>(<span style='color:darkgreen'>regular_dash</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>commit</span>(<span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>query</span>(<span style='color:darkgreen'>Dashboard</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>filter_by</span>(<span style='color:darkgreen'>slug</span><span style='color:deepskyblue'>=</span><span style='color:darkgreen'>fav_dash_slug</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>first</span>(<span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>favorites</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>models</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>FavStar</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>favorites</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>obj_id</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>id</span>
        <span style='color:darkgreen'>favorites</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>class_name</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"Dashboard"</span>
        <span style='color:darkgreen'>favorites</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>user_id</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>user</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>id</span>

        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>merge</span>(<span style='color:darkgreen'>favorites</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>commit</span>(<span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>login</span>(<span style='color:darkgreen'>user</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>username</span><span style='color:deepskyblue'>)</span>

        <span style='color:darkgreen'>resp</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:crimson'>"/api/v1/dashboard/"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertIn</span>(<span style='color:crimson'>f"/superset/dashboard/{fav_dash_slug}/"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>)</span>

    <span style='color:blueviolet'>def</span> <span style='color:darkgreen'>test_user_can_not_view_unpublished_dash</span>(<span style='color:darkgreen'>self</span><span style='color:deepskyblue'>)</span><span style='color:deepskyblue'>:</span>
        <span style='color:darkgreen'>admin_user</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>security_manager</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>find_user</span>(<span style='color:crimson'>"admin"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>gamma_user</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>security_manager</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>find_user</span>(<span style='color:crimson'>"gamma"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>slug</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>f"admin_owned_unpublished_dash_{random()}"</span>

        <span style='color:darkblue'># Create a dashboard owned by admin and unpublished</span>
        <span style='color:darkgreen'>dash</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>Dashboard</span>(<span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>dashboard_title</span> <span style='color:deepskyblue'>=</span> <span style='color:crimson'>"My Dashboard"</span>
        <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slug</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>slug</span>
        <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>owners</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>[</span><span style='color:darkgreen'>admin_user</span><span style='color:deepskyblue'>]</span>
        <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>slices</span> <span style='color:deepskyblue'>=</span> <span style='color:deepskyblue'>[</span><span style='color:deepskyblue'>]</span>
        <span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>published</span> <span style='color:deepskyblue'>=</span> <span style='color:blueviolet'>False</span>
        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>merge</span>(<span style='color:darkgreen'>dash</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>db</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>session</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>commit</span>(<span style='color:deepskyblue'>)</span>

        <span style='color:darkblue'># list dashboards as a gamma user</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>login</span>(<span style='color:darkgreen'>gamma_user</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>username</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>resp</span> <span style='color:deepskyblue'>=</span> <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>get_resp</span>(<span style='color:crimson'>"/api/v1/dashboard/"</span><span style='color:deepskyblue'>)</span>
        <span style='color:darkgreen'>self</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>assertNotIn</span>(<span style='color:crimson'>f"/superset/dashboard/{slug}/"</span><span style='color:deepskyblue'>,</span> <span style='color:darkgreen'>resp</span><span style='color:deepskyblue'>)</span>


<span style='color:blueviolet'>if</span> <span style='color:darkgreen'>__name__</span> <span style='color:deepskyblue'>=</span><span style='color:deepskyblue'>=</span> <span style='color:crimson'>"__main__"</span><span style='color:deepskyblue'>:</span>
    <span style='color:darkgreen'>unittest</span><span style='color:deepskyblue'>.</span><span style='color:darkgreen'>main</span>(<span style='color:deepskyblue'>)</span>
        </pre>
    </body>
</html>